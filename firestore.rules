rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Wallpapers - public read access
    match /wallpapers/{category}/photos/{photoId} {
      allow read: if true;
      allow write: if false; // Only Cloud Functions can write
    }

    // User data - authenticated users only
    match /users/{userId} {
      // User profile and settings - allow read/write for own document with validation
      allow read: if isOwner(userId);
      allow write: if isOwner(userId)
        // Validate nickname if present
        && (!request.resource.data.keys().hasAny(['nickname'])
            || (request.resource.data.nickname is string
                && request.resource.data.nickname.size() > 0
                && request.resource.data.nickname.size() <= 30))
        // Validate settings if present
        && (!request.resource.data.keys().hasAny(['settings'])
            || (request.resource.data.settings is map
                && (!request.resource.data.settings.keys().hasAny(['weather'])
                    || (request.resource.data.settings.weather is map
                        && request.resource.data.settings.weather.auto is bool
                        && request.resource.data.settings.weather.cityName is string
                        && request.resource.data.settings.weather.lat is number
                        && request.resource.data.settings.weather.lon is number
                        // unit is optional, validate if present
                        && (!request.resource.data.settings.weather.keys().hasAny(['unit'])
                            || request.resource.data.settings.weather.unit in ['metric', 'imperial'])))));

      // Todo Lists
      match /todolists/{listId} {
        allow read: if isOwner(userId);
        allow delete: if isOwner(userId) && !resource.data.isDefault; // Cannot delete default list
        allow create: if isOwner(userId)
          && request.resource.data.name is string
          && request.resource.data.name.size() > 0
          && request.resource.data.name.size() <= 50;
        allow update: if isOwner(userId)
          && request.resource.data.name is string
          && request.resource.data.name.size() > 0
          && request.resource.data.name.size() <= 50;
      }

      // User todos - with validation
      match /todos/{todoId} {
        allow read: if isOwner(userId);
        allow delete: if isOwner(userId);

        // Create: validate text length and listId
        allow create: if isOwner(userId)
          && request.resource.data.text is string
          && request.resource.data.text.size() > 0
          && request.resource.data.text.size() <= 100
          && request.resource.data.listId is string
          && request.resource.data.completed is bool;

        // Update: only allow toggling completed status
        allow update: if isOwner(userId)
          && request.resource.data.text == resource.data.text
          && request.resource.data.listId == resource.data.listId
          && request.resource.data.completed is bool;
      }

      // User favorites (wallpapers) - limit enforced in client code
      match /favorites/{wallpaperId} {
        allow read: if isOwner(userId);
        allow delete: if isOwner(userId);

        // Create: validate required fields (limit of 9 enforced in client)
        allow create: if isOwner(userId)
          && request.resource.data.imageUrl is string
          && request.resource.data.photographer is string
          && request.resource.data.photographerUrl is string
          && request.resource.data.photoUrl is string
          && request.resource.data.category is string;
        // Note: Count limit is enforced in client code before creation
        // Firestore rules cannot efficiently count collection size
      }
    }
  }
}
